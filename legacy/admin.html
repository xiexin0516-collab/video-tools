<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜é¢æ¿ - å­—å¹•ç¼–è¾‘å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .admin-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 1px solid #404040;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border: 1px solid #3b82f6;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border: 1px solid #ef4444;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-red-400">ç®¡ç†å‘˜é¢æ¿</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-300" id="userInfo">ç®¡ç†å‘˜</span>
                    <button id="logoutBtn" class="bg-gray-700 px-4 py-2 rounded-lg text-white">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="admin-card rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-2">æ€»ç”¨æˆ·æ•°</h3>
                <p class="text-3xl font-bold text-blue-400" id="totalUsers">-</p>
            </div>
            <div class="admin-card rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-2">æ€»é¡¹ç›®æ•°</h3>
                <p class="text-3xl font-bold text-green-400" id="totalProjects">-</p>
            </div>
            <div class="admin-card rounded-lg p-6">
                <h3 class="text-lg font-semibold text-white mb-2">æ•°æ®åº“çŠ¶æ€</h3>
                <p class="text-3xl font-bold text-yellow-400" id="dbStatus">æ­£å¸¸</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="admin-card rounded-lg p-6 mb-8">
            <h3 class="text-lg font-semibold text-white mb-4">å¿«é€Ÿæ“ä½œ</h3>
            <div class="flex flex-wrap gap-4">
                <button id="exportDbBtn" class="btn-primary px-6 py-3 rounded-lg text-white">
                    ğŸ“Š å¯¼å‡ºæ•°æ®åº“
                </button>
                <button id="backupDbBtn" class="btn-primary px-6 py-3 rounded-lg text-white">
                    ğŸ’¾ å¤‡ä»½æ•°æ®åº“
                </button>
                <button id="refreshBtn" class="bg-gray-700 px-6 py-3 rounded-lg text-white">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="admin-card rounded-lg p-6">
            <div class="flex space-x-4 mb-6">
                <button id="usersTab" class="px-4 py-2 rounded-lg bg-blue-600 text-white">
                    ç”¨æˆ·ç®¡ç†
                </button>
                <button id="projectsTab" class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300">
                    é¡¹ç›®ç®¡ç†
                </button>
            </div>

            <!-- Users Tab Content -->
            <div id="usersContent">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">ç”¨æˆ·åˆ—è¡¨</h3>
                    <input 
                        type="text" 
                        id="searchUsers" 
                        placeholder="æœç´¢ç”¨æˆ·..."
                        class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                    >
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-gray-300">
                        <thead class="text-sm text-gray-400 border-b border-gray-700">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">ç”¨æˆ·å</th>
                                <th class="px-4 py-3">é‚®ç®±</th>
                                <th class="px-4 py-3">æ³¨å†Œæ—¶é—´</th>
                                <th class="px-4 py-3">æœ€åç™»å½•</th>
                                <th class="px-4 py-3">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="usersPagination" class="mt-4 flex justify-center">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>

            <!-- Projects Tab Content -->
            <div id="projectsContent" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">é¡¹ç›®åˆ—è¡¨</h3>
                    <input 
                        type="text" 
                        id="searchProjects" 
                        placeholder="æœç´¢é¡¹ç›®..."
                        class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                    >
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-gray-300">
                        <thead class="text-sm text-gray-400 border-b border-gray-700">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">é¡¹ç›®å</th>
                                <th class="px-4 py-3">ç”¨æˆ·ID</th>
                                <th class="px-4 py-3">åˆ›å»ºæ—¶é—´</th>
                                <th class="px-4 py-3">æ›´æ–°æ—¶é—´</th>
                                <th class="px-4 py-3">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <!-- Projects will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="projectsPagination" class="mt-4 flex justify-center">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentUser = null;
        let currentTab = 'users';
        let usersData = [];
        let projectsData = [];

        // Check authentication and admin status
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                window.location.href = '/login';
                return;
            }
            
            try {
                currentUser = JSON.parse(user);
                document.getElementById('userInfo').textContent = `ç®¡ç†å‘˜: ${currentUser.username}`;
                
                // Check if user is admin
                if (!['admin', 'xiexin'].includes(currentUser.username)) {
                    alert('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™');
                    window.location.href = '/dashboard';
                }
            } catch (error) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
        }

        // API helper function
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('access_token');
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            const response = await fetch(endpoint, { ...defaultOptions, ...options });
            
            if (response.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
                return null;
            }
            
            return response.json();
        }

        // Load admin dashboard
        async function loadDashboard() {
            try {
                const result = await apiCall('/api/admin/dashboard');
                
                if (result && result.success) {
                    document.getElementById('totalUsers').textContent = result.stats.total_users;
                    document.getElementById('totalProjects').textContent = result.stats.total_projects;
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        // Load users
        async function loadUsers(page = 1) {
            try {
                const result = await apiCall(`/api/admin/users?page=${page}`);
                
                if (result && result.success) {
                    usersData = result.users;
                    displayUsers(usersData);
                    displayPagination(result.pagination, 'users');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        // Load projects
        async function loadProjects(page = 1) {
            try {
                const result = await apiCall(`/api/admin/projects?page=${page}`);
                
                if (result && result.success) {
                    projectsData = result.projects;
                    displayProjects(projectsData);
                    displayPagination(result.pagination, 'projects');
                }
            } catch (error) {
                console.error('Failed to load projects:', error);
            }
        }

        // Display users
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = users.map(user => `
                <tr class="border-b border-gray-700 hover:bg-gray-800">
                    <td class="px-4 py-3">${user.id}</td>
                    <td class="px-4 py-3">${user.username}</td>
                    <td class="px-4 py-3">${user.email}</td>
                    <td class="px-4 py-3">${new Date(user.created_at).toLocaleString()}</td>
                    <td class="px-4 py-3">${user.last_login ? new Date(user.last_login).toLocaleString() : 'ä»æœªç™»å½•'}</td>
                    <td class="px-4 py-3">
                        <button onclick="viewUserDetails(${user.id})" class="text-blue-400 hover:text-blue-300 mr-2">
                            æŸ¥çœ‹
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Display projects
        function displayProjects(projects) {
            const tbody = document.getElementById('projectsTableBody');
            tbody.innerHTML = projects.map(project => `
                <tr class="border-b border-gray-700 hover:bg-gray-800">
                    <td class="px-4 py-3">${project.id}</td>
                    <td class="px-4 py-3">${project.name}</td>
                    <td class="px-4 py-3">${project.user_id}</td>
                    <td class="px-4 py-3">${new Date(project.created_at).toLocaleString()}</td>
                    <td class="px-4 py-3">${new Date(project.updated_at).toLocaleString()}</td>
                    <td class="px-4 py-3">
                        <button onclick="viewProjectDetails(${project.id})" class="text-blue-400 hover:text-blue-300 mr-2">
                            æŸ¥çœ‹
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Display pagination
        function displayPagination(pagination, type) {
            const container = document.getElementById(`${type}Pagination`);
            const { page, pages, has_next, has_prev } = pagination;
            
            let html = '<div class="flex space-x-2">';
            
            if (has_prev) {
                html += `<button onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}(${page - 1})" class="px-3 py-1 bg-gray-700 rounded text-white">ä¸Šä¸€é¡µ</button>`;
            }
            
            html += `<span class="px-3 py-1 text-gray-300">ç¬¬ ${page} é¡µï¼Œå…± ${pages} é¡µ</span>`;
            
            if (has_next) {
                html += `<button onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}(${page + 1})" class="px-3 py-1 bg-gray-700 rounded text-white">ä¸‹ä¸€é¡µ</button>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Export database
        async function exportDatabase() {
            try {
                const result = await apiCall('/api/admin/database/export');
                
                if (result) {
                    const dataStr = JSON.stringify(result, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `database_export_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // Backup database
        async function backupDatabase() {
            try {
                const result = await apiCall('/api/admin/database/backup', {
                    method: 'POST'
                });
                
                if (result && result.success) {
                    alert('æ•°æ®åº“å¤‡ä»½æˆåŠŸï¼');
                }
            } catch (error) {
                alert('å¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.getElementById('usersTab').className = tab === 'users' ? 'px-4 py-2 rounded-lg bg-blue-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-700 text-gray-300';
            document.getElementById('projectsTab').className = tab === 'projects' ? 'px-4 py-2 rounded-lg bg-blue-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-700 text-gray-300';
            
            // Update content
            document.getElementById('usersContent').classList.toggle('hidden', tab !== 'users');
            document.getElementById('projectsContent').classList.toggle('hidden', tab !== 'projects');
            
            // Load data
            if (tab === 'users') {
                loadUsers();
            } else {
                loadProjects();
            }
        }

        // Event listeners
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        });

        document.getElementById('usersTab').addEventListener('click', () => switchTab('users'));
        document.getElementById('projectsTab').addEventListener('click', () => switchTab('projects'));
        document.getElementById('exportDbBtn').addEventListener('click', exportDatabase);
        document.getElementById('backupDbBtn').addEventListener('click', backupDatabase);
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadDashboard();
            if (currentTab === 'users') {
                loadUsers();
            } else {
                loadProjects();
            }
        });

        // Search functionality
        document.getElementById('searchUsers').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = usersData.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        });

        document.getElementById('searchProjects').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredProjects = projectsData.filter(project => 
                project.name.toLowerCase().includes(searchTerm)
            );
            displayProjects(filteredProjects);
        });

        // Initialize
        checkAuth();
        loadDashboard();
        loadUsers();
    </script>
</body>
</html>

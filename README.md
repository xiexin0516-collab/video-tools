# 视频工具平台

专业的视频处理工具平台，支持字幕编辑、音频处理、视频特效等功能。

## 🏗️ 架构

- **前端**: 静态网站 (Render Static Site)
- **后端**: Flask API服务 (Render Web Service)
- **认证**: Supabase Auth
- **数据库**: Supabase PostgreSQL
- **存储**: Supabase Storage

## 🚀 快速开始

### 1. Supabase 配置

#### 创建 Supabase 项目

1. 访问 [Supabase](https://supabase.com) 创建新项目
2. 记录项目 URL 和 API 密钥

#### 数据库表结构

在 Supabase SQL Editor 中执行以下 SQL：

```sql
-- 创建项目表
create table if not exists public.projects (
  id          bigint generated by default as identity primary key,
  user_id     uuid not null,
  name        text not null,
  audio_url   text,
  subtitles   jsonb,
  created_at  timestamptz default now(),
  updated_at  timestamptz default now()
);

-- 启用行级安全
alter table public.projects enable row level security;

-- 创建安全策略
create policy "projects_owner_select" on public.projects
for select to authenticated
using (user_id = auth.uid());

create policy "projects_owner_insert" on public.projects
for insert to authenticated
with check (user_id = auth.uid());

create policy "projects_owner_update" on public.projects
for update to authenticated
using (user_id = auth.uid());

create policy "projects_owner_delete" on public.projects
for delete to authenticated
using (user_id = auth.uid());
```

#### Storage 配置

1. 在 Supabase Dashboard 中创建 Storage bucket: `vidtools`
2. 设置为私有 bucket
3. 执行以下 SQL 创建存储策略：

```sql
-- 允许用户读取自己的文件
create policy "allow_read_own_files" on storage.objects
for select to authenticated
using (bucket_id = 'vidtools' and owner = auth.uid());

-- 允许用户上传自己的文件
create policy "allow_write_own_files" on storage.objects
for insert to authenticated
with check (bucket_id = 'vidtools' and owner = auth.uid());
```

#### Auth 配置

在 Supabase Dashboard > Authentication > Settings 中配置：

- **Site URL**: `https://vidtools.tools`
- **Redirect URLs**: `https://vidtools.tools/auth/callback`
- 启用 Email 认证

### 2. 环境变量配置

#### 后端环境变量 (Render Web Service)

在 Render Dashboard 中配置以下环境变量：

```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_JWKS_URL=https://your-project.supabase.co/auth/v1/jwks
SUPABASE_SERVICE_ROLE=your-service-role-key
DATABASE_URL=postgresql+psycopg2://postgres:[password]@[host]:5432/postgres
SECRET_KEY=your-secret-key
```

#### 前端配置

在 `frontend/js/supabaseClient.js` 中更新：

```javascript
const SUPABASE_URL = 'https://your-project.supabase.co'
const SUPABASE_ANON_KEY = 'your-anon-key'
```

### 3. Render 部署

#### 前端部署 (Static Site)

1. 在 Render 创建新的 **Static Site**
2. **Build Command**: 无
3. **Publish Directory**: `frontend`
4. **Environment Variables**: 无

#### 后端部署 (Web Service)

1. 在 Render 创建新的 **Web Service**
2. **Build Command**: `pip install -r requirements.txt`
3. **Start Command**: `python app.py`
4. **Environment Variables**: 配置上述后端环境变量

### 4. 域名配置

1. 在 Render 中为前端配置自定义域名: `vidtools.tools`
2. 为后端配置子域名: `api.vidtools.tools`
3. 在前端代码中更新 API 基础 URL

## 📁 项目结构

```
/
├─ frontend/           # 静态前端
│  ├─ index.html       # 主页
│  ├─ login/           # 登录页面
│  ├─ subtitle-editor/ # 字幕编辑器
│  ├─ admin/           # 管理员面板
│  └─ js/
│     ├─ supabaseClient.js  # Supabase客户端
│     └─ api.js             # API封装
├─ backend/            # Flask API服务
│  ├─ app.py           # 主应用
│  └─ requirements.txt # 依赖
├─ legacy/             # 桌面版文件
└─ README.md           # 说明文档
```

## 🔧 开发

### 本地开发

1. 克隆仓库
```bash
git clone https://github.com/your-username/video-tools.git
cd video-tools
```

2. 安装后端依赖
```bash
cd backend
pip install -r requirements.txt
```

3. 配置环境变量
```bash
cp .env.example .env
# 编辑 .env 文件，填入 Supabase 配置
```

4. 启动后端服务
```bash
python app.py
```

5. 启动前端服务
```bash
cd ../frontend
# 使用任何静态文件服务器，如 Python 内置服务器
python -m http.server 3000
```

### API 接口

#### 认证接口

所有需要认证的接口都需要在请求头中包含：
```
Authorization: Bearer <supabase-access-token>
```

#### 项目接口

- `GET /api/projects` - 获取用户项目列表
- `POST /api/projects` - 创建新项目
- `GET /api/projects/<id>` - 获取单个项目
- `PUT /api/projects/<id>` - 更新项目
- `DELETE /api/projects/<id>` - 删除项目

#### 存储接口

- `POST /api/storage/sign` - 生成文件上传/下载签名URL

## 🔒 安全说明

- 前端不要暴露 `SERVICE_ROLE_KEY`
- 所有文件上传使用签名URL
- 数据库启用行级安全策略
- JWT令牌通过Supabase JWKS验证

## 🐛 常见问题

### 1. JWT验证失败

检查：
- `SUPABASE_JWKS_URL` 是否正确
- 网络连接是否正常
- JWT令牌是否过期

### 2. 数据库连接失败

检查：
- `DATABASE_URL` 格式是否正确
- Supabase数据库是否正常运行
- 网络连接是否正常

### 3. 文件上传失败

检查：
- Storage bucket 是否创建
- 存储策略是否正确配置
- 签名URL是否有效

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！ 
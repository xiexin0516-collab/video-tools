# è§†é¢‘å·¥å…·å¹³å°

ä¸“ä¸šçš„è§†é¢‘å¤„ç†å·¥å…·å¹³å°ï¼Œæ”¯æŒå­—å¹•ç¼–è¾‘ã€éŸ³é¢‘å¤„ç†ã€è§†é¢‘ç‰¹æ•ˆç­‰åŠŸèƒ½ã€‚

## ğŸ—ï¸ æ¶æ„

- **å‰ç«¯**: é™æ€ç½‘ç«™ (Render Static Site)
- **åç«¯**: Flask APIæœåŠ¡ (Render Web Service)
- **è®¤è¯**: Supabase Auth
- **æ•°æ®åº“**: Supabase PostgreSQL
- **å­˜å‚¨**: Supabase Storage

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. Supabase é…ç½®

#### åˆ›å»º Supabase é¡¹ç›®

1. è®¿é—® [Supabase](https://supabase.com) åˆ›å»ºæ–°é¡¹ç›®
2. è®°å½•é¡¹ç›® URL å’Œ API å¯†é’¥

#### æ•°æ®åº“è¡¨ç»“æ„

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- åˆ›å»ºé¡¹ç›®è¡¨
create table if not exists public.projects (
  id          bigint generated by default as identity primary key,
  user_id     uuid not null,
  name        text not null,
  audio_url   text,
  subtitles   jsonb,
  created_at  timestamptz default now(),
  updated_at  timestamptz default now()
);

-- å¯ç”¨è¡Œçº§å®‰å…¨
alter table public.projects enable row level security;

-- åˆ›å»ºå®‰å…¨ç­–ç•¥
create policy "projects_owner_select" on public.projects
for select to authenticated
using (user_id = auth.uid());

create policy "projects_owner_insert" on public.projects
for insert to authenticated
with check (user_id = auth.uid());

create policy "projects_owner_update" on public.projects
for update to authenticated
using (user_id = auth.uid());

create policy "projects_owner_delete" on public.projects
for delete to authenticated
using (user_id = auth.uid());
```

#### Storage é…ç½®

1. åœ¨ Supabase Dashboard ä¸­åˆ›å»º Storage bucket: `vidtools`
2. è®¾ç½®ä¸ºç§æœ‰ bucket
3. æ‰§è¡Œä»¥ä¸‹ SQL åˆ›å»ºå­˜å‚¨ç­–ç•¥ï¼š

```sql
-- å…è®¸ç”¨æˆ·è¯»å–è‡ªå·±çš„æ–‡ä»¶
create policy "allow_read_own_files" on storage.objects
for select to authenticated
using (bucket_id = 'vidtools' and owner = auth.uid());

-- å…è®¸ç”¨æˆ·ä¸Šä¼ è‡ªå·±çš„æ–‡ä»¶
create policy "allow_write_own_files" on storage.objects
for insert to authenticated
with check (bucket_id = 'vidtools' and owner = auth.uid());
```

#### Auth é…ç½®

åœ¨ Supabase Dashboard > Authentication > Settings ä¸­é…ç½®ï¼š

- **Site URL**: `https://vidtools.tools`
- **Redirect URLs**: `https://vidtools.tools/auth/callback`
- å¯ç”¨ Email è®¤è¯

### 2. ç¯å¢ƒå˜é‡é…ç½®

#### åç«¯ç¯å¢ƒå˜é‡ (Render Web Service)

åœ¨ Render Dashboard ä¸­é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_JWKS_URL=https://your-project.supabase.co/auth/v1/jwks
SUPABASE_SERVICE_ROLE=your-service-role-key
DATABASE_URL=postgresql+psycopg2://postgres:[password]@[host]:5432/postgres
SECRET_KEY=your-secret-key
```

#### å‰ç«¯é…ç½®

åœ¨ `frontend/js/supabaseClient.js` ä¸­æ›´æ–°ï¼š

```javascript
const SUPABASE_URL = 'https://your-project.supabase.co'
const SUPABASE_ANON_KEY = 'your-anon-key'
```

### 3. Render éƒ¨ç½²

#### å‰ç«¯éƒ¨ç½² (Static Site)

1. åœ¨ Render åˆ›å»ºæ–°çš„ **Static Site**
2. **Build Command**: æ— 
3. **Publish Directory**: `frontend`
4. **Environment Variables**: æ— 

#### åç«¯éƒ¨ç½² (Web Service)

1. åœ¨ Render åˆ›å»ºæ–°çš„ **Web Service**
2. **Build Command**: `pip install -r requirements.txt`
3. **Start Command**: `python app.py`
4. **Environment Variables**: é…ç½®ä¸Šè¿°åç«¯ç¯å¢ƒå˜é‡

### 4. åŸŸåé…ç½®

1. åœ¨ Render ä¸­ä¸ºå‰ç«¯é…ç½®è‡ªå®šä¹‰åŸŸå: `vidtools.tools`
2. ä¸ºåç«¯é…ç½®å­åŸŸå: `api.vidtools.tools`
3. åœ¨å‰ç«¯ä»£ç ä¸­æ›´æ–° API åŸºç¡€ URL

## ğŸ“ é¡¹ç›®ç»“æ„

```
/
â”œâ”€ frontend/           # é™æ€å‰ç«¯
â”‚  â”œâ”€ index.html       # ä¸»é¡µ
â”‚  â”œâ”€ login/           # ç™»å½•é¡µé¢
â”‚  â”œâ”€ subtitle-editor/ # å­—å¹•ç¼–è¾‘å™¨
â”‚  â”œâ”€ admin/           # ç®¡ç†å‘˜é¢æ¿
â”‚  â””â”€ js/
â”‚     â”œâ”€ supabaseClient.js  # Supabaseå®¢æˆ·ç«¯
â”‚     â””â”€ api.js             # APIå°è£…
â”œâ”€ backend/            # Flask APIæœåŠ¡
â”‚  â”œâ”€ app.py           # ä¸»åº”ç”¨
â”‚  â””â”€ requirements.txt # ä¾èµ–
â”œâ”€ legacy/             # æ¡Œé¢ç‰ˆæ–‡ä»¶
â””â”€ README.md           # è¯´æ˜æ–‡æ¡£
```

## ğŸ”§ å¼€å‘

### æœ¬åœ°å¼€å‘

1. å…‹éš†ä»“åº“
```bash
git clone https://github.com/your-username/video-tools.git
cd video-tools
```

2. å®‰è£…åç«¯ä¾èµ–
```bash
cd backend
pip install -r requirements.txt
```

3. é…ç½®ç¯å¢ƒå˜é‡
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ Supabase é…ç½®
```

4. å¯åŠ¨åç«¯æœåŠ¡
```bash
python app.py
```

5. å¯åŠ¨å‰ç«¯æœåŠ¡
```bash
cd ../frontend
# ä½¿ç”¨ä»»ä½•é™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼Œå¦‚ Python å†…ç½®æœåŠ¡å™¨
python -m http.server 3000
```

### API æ¥å£

#### è®¤è¯æ¥å£

æ‰€æœ‰éœ€è¦è®¤è¯çš„æ¥å£éƒ½éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«ï¼š
```
Authorization: Bearer <supabase-access-token>
```

#### é¡¹ç›®æ¥å£

- `GET /api/projects` - è·å–ç”¨æˆ·é¡¹ç›®åˆ—è¡¨
- `POST /api/projects` - åˆ›å»ºæ–°é¡¹ç›®
- `GET /api/projects/<id>` - è·å–å•ä¸ªé¡¹ç›®
- `PUT /api/projects/<id>` - æ›´æ–°é¡¹ç›®
- `DELETE /api/projects/<id>` - åˆ é™¤é¡¹ç›®

#### å­˜å‚¨æ¥å£

- `POST /api/storage/sign` - ç”Ÿæˆæ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ç­¾åURL

## ğŸ”’ å®‰å…¨è¯´æ˜

- å‰ç«¯ä¸è¦æš´éœ² `SERVICE_ROLE_KEY`
- æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ ä½¿ç”¨ç­¾åURL
- æ•°æ®åº“å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥
- JWTä»¤ç‰Œé€šè¿‡Supabase JWKSéªŒè¯

## ğŸ› å¸¸è§é—®é¢˜

### 1. JWTéªŒè¯å¤±è´¥

æ£€æŸ¥ï¼š
- `SUPABASE_JWKS_URL` æ˜¯å¦æ­£ç¡®
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- JWTä»¤ç‰Œæ˜¯å¦è¿‡æœŸ

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

æ£€æŸ¥ï¼š
- `DATABASE_URL` æ ¼å¼æ˜¯å¦æ­£ç¡®
- Supabaseæ•°æ®åº“æ˜¯å¦æ­£å¸¸è¿è¡Œ
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### 3. æ–‡ä»¶ä¸Šä¼ å¤±è´¥

æ£€æŸ¥ï¼š
- Storage bucket æ˜¯å¦åˆ›å»º
- å­˜å‚¨ç­–ç•¥æ˜¯å¦æ­£ç¡®é…ç½®
- ç­¾åURLæ˜¯å¦æœ‰æ•ˆ

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼ 